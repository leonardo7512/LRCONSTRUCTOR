<!DOCTYPE html>

<html lang="es">

<head>

Â  Â  <meta charset="UTF-8">

Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  Â  <title>Constructor de Pedidos PRO v26 - EdiciÃ³n EstÃ¡ndar</title>

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

Â  Â  <style>

Â  Â  Â  Â  :root { --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-light: rgba(255, 255, 255, 0.95); --text-dark: #2c3e50; --accent-blue: #3498db; --accent-green: #28a745; --accent-red: #dc3545; --btn-whatsapp: #25D366; }

Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }

Â  Â  Â  Â  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: var(--primary-grad); min-height: 100vh; }

Â  Â  Â  Â  .container { max-width: 1500px; margin: 0 auto; padding: 20px; }

Â  Â  Â  Â  .panel { background: var(--bg-light); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }

Â  Â  Â  Â  h1, h3 { color: var(--text-dark); }

Â  Â  Â  Â  h1 { text-align: center; margin-bottom: 20px; font-size: 2.5rem; }

Â  Â  Â  Â  #loading-section { padding: 40px; text-align: center; }

Â  Â  Â  Â  #main-app { display: none; }

Â  Â  Â  Â  .config-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; align-items: end; }

Â  Â  Â  Â  .config-group label { font-weight: 600; margin-bottom: 5px; color: var(--text-dark); display: block; }

Â  Â  Â  Â  select, input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; background-color: white; }

Â  Â  Â  Â  .main-content { display: flex; flex-direction: column; gap: 20px; }

Â  Â  Â  Â  .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }

Â  Â  Â  Â  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

Â  Â  Â  Â  .btn-primary { background: var(--primary-grad); color: white; }

Â  Â  Â  Â  .btn-info { background: var(--accent-blue); color: white; }

Â  Â  Â  Â  .btn-success { background: var(--accent-green); color: white; }

Â  Â  Â  Â  .btn-danger { background: var(--accent-red); color: white; }

Â  Â  Â  Â  .btn-whatsapp { background: var(--btn-whatsapp); color: white; }

Â  Â  Â  Â  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; max-height: 45vh; overflow-y: auto; padding: 5px; }

Â  Â  Â  Â  .product-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid #667eea; }

Â  Â  Â  Â  .product-sku { font-weight: 700; color: #667eea; }

Â  Â  Â  Â  .product-description { font-size: 13px; color: #666; margin-bottom: 10px; }

Â  Â  Â  Â  .quantity-input { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }

Â  Â  Â  Â  .order-section-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }

Â  Â  Â  Â  .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }

Â  Â  Â  Â  .order-total { font-size: 18px; font-weight: 700; color: var(--accent-green); }

Â  Â  Â  Â  .order-items { max-height: 50vh; overflow-y: auto; }

Â  Â  Â  Â  .order-item { background: #f8f9fa; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent-green); position: relative; }

Â  Â  Â  Â  .order-item-info .sku { font-weight: 600; color: #667eea; font-size: 14px; }

Â  Â  Â  Â  .order-item-info .desc { font-size: 12px; color: #666; }

Â  Â  Â  Â  .order-item-controls { display: flex; align-items: center; gap: 10px; }

Â  Â  Â  Â  .order-item-controls input[type="number"] { width: 60px; padding: 5px; text-align: center; }

Â  Â  Â  Â  .price-details { text-align: right; }

Â  Â  Â  Â  .unit-price-input { width: 80px; text-align: right; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

Â  Â  Â  Â  .price-details .line-total { font-size: 14px; font-weight: bold; display: block; margin-top: 5px;}

Â  Â  Â  Â  .price-override-section { display: flex; gap: 5px; align-items: center; }

Â  Â  Â  Â  .price-override-section select { font-size: 12px; padding: 5px; flex-grow: 1; }

Â  Â  Â  Â  .btn-reset { background: #f0ad4e; color: white; border: 0; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer; }

Â  Â  Â  Â  .btn-remove-item { position: absolute; top: 5px; right: 5px; background: var(--accent-red); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; line-height: 22px; text-align: center; font-size: 14px; }

Â  Â  Â  Â  .global-price-applicator { background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 15px; }

Â  Â  Â  Â  .global-price-applicator .controls { display: flex; gap: 10px; }

Â  Â  Â  Â  .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;}

Â  Â  Â  Â  .copy-output { background: var(--text-dark); color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; margin-top: 10px; }

Â  Â  Â  Â  .filters-section { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; align-items: center;}

Â  Â  Â  Â Â 

Â  Â  Â  Â  @media (max-width: 900px) { .order-section-grid { grid-template-columns: 1fr; } .order-item { grid-template-columns: 1fr; } }

Â  Â  </style>

</head>

<body>

Â  Â  <div class="container">

Â  Â  Â  Â  <div id="loading-section" class="panel">

Â  Â  Â  Â  Â  Â  <h1 style="font-size: 2rem;">Constructor de Pedidos</h1>

Â  Â  Â  Â  Â  Â  <p id="loading-status" style="color: #667eea; font-weight: 600;">Cargando catÃ¡logo desde la nube...</p>

Â  Â  Â  Â  </div>



Â  Â  Â  Â  <div id="main-app">

Â  Â  Â  Â  Â  Â  <div class="panel header"><h1>ğŸ›ï¸ Constructor de Pedidos PRO</h1>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="config-panel">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="config-group"><label for="clientName">Nombre Cliente:</label><input type="text" id="clientName" placeholder="Requerido para descarga..."></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="config-group"><label>Modalidad:</label><select id="deliveryMode"><option value="RETIRO">RETIRO EN BODEGA</option><option value="ENVÃO">ENVÃO A DOMICILIO</option><option value="ENVÃO OFC">ENVÃO A OFICINA</option></select></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="config-group"><label>Documento:</label><select id="documentType"><option value="BOLETA">BOLETA</option><option value="FACTURA">FACTURA</option></select></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="config-group"><label>Mostrar Precios:</label><select id="showPrices"><option value="BRUTO">BRUTO (con IVA)</option><option value="NETO">NETO (sin IVA)</option></select></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="config-group"><label>Importar Pedido:</label><button id="importOrderBtn" class="btn btn-primary" onclick="triggerImport()">Importar</button><input type="file" id="importFile" accept=".csv" style="display:none;"></div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="main-content">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel catalog-section">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>BÃºsqueda de Productos</h3>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-section">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="searchInput" placeholder="Buscar por SKU o descripciÃ³n..." onkeyup="filterProducts()">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="categoryFilter" onchange="filterProducts()"><option value="">Todas las CategorÃ­as</option></select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="itemsPerPage" onchange="filterProducts()"><option value="50" selected>50</option><option value="100">100</option><option value="all">Todos</option></select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="productsContainer"></div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>



Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel order-section">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-header"><h3>Pedido Actual</h3><div class="order-total" id="orderTotal">$0</div></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-section-grid">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-items" id="orderItems"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-actions">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="global-price-applicator">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-weight:600; font-size:14px; display:block; margin-bottom:5px;">Aplicar Precio a Todo:</label>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="globalPriceSelector"><option value="DETALLE">DETALLE</option><option value="MAYOR">MAYOR</option></select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" style="padding: 5px 10px;" onclick="applyGlobalPrice()">OK</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="actions-grid">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success" onclick="generateExcelOutput()">ğŸ“‹ Copiar Sistema</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-whatsapp" onclick="generateWhatsappSummary()">ğŸ’¬ Copiar WhatsApp</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="downloadExcel()" style="width:100%; margin-bottom:10px;">ğŸ“¥ Descargar Excel</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-info" onclick="downloadBsaleCsv()" style="width:100%; margin-bottom:10px;">ğŸ“„ Exportar BSale</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="generateSummaryNote()" style="width:100%; margin-bottom:10px;">ğŸ“ Nota Bodega</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="clearOrder()" style="width:100%;">ğŸ—‘ï¸ Limpiar Pedido</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="copyOutput" class="copy-output" style="display: none; margin-top: 10px;"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  </div>



Â  Â  <script>

Â  Â  Â  Â  let allProducts = [], pricesBySku = {}, currentOrder = [];



Â  Â  Â  Â  const CATALOG_URL = 'https://raw.githubusercontent.com/leonardo7512/CORRECTORPRECIOS/main/2708CATALOGO_ACTUALIZADO3.csv';



Â  Â  Â  Â  async function loadCatalogFromUrl() {

Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('loading-status');

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  const urlWithCacheBuster = `${CATALOG_URL}?v=${new Date().getTime()}`;

Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(urlWithCacheBuster);

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);

Â  Â  Â  Â  Â  Â  Â  Â  const csvText = await response.text();

Â  Â  Â  Â  Â  Â  Â  Â  Papa.parse(csvText, {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delimiter: ";",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  skipEmptyLines: true,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  encoding: "UTF-8",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  complete: (results) => processCSVData(results.data),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  error: (err) => { throw new Error(`Error al procesar CSV: ${err.message}`); }

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {

Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fallo al cargar el catÃ¡logo:", error);

Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerText = `Error al cargar el catÃ¡logo. Revisa la URL o tu conexiÃ³n.`;

Â  Â  Â  Â  Â  Â  Â  Â  statusEl.style.color = 'red';

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }



Â  Â  Â  Â  function getCategoriaPrecios(d) {

Â  Â  Â  Â  Â  Â  const match = String(d).trim().match(/(.*?)\s*-\s*/);

Â  Â  Â  Â  Â  Â  return (match && match[1]) ? match[1].trim().replace(/"/g, '') : "General";

Â  Â  Â  Â  }



Â  Â  Â  Â  function processCSVData(data) {

Â  Â  Â  Â  Â  Â  const products = [], localPrices = {}, categories = new Set();

Â  Â  Â  Â  Â  Â  for (let i = 1; i < data.length; i++) {

Â  Â  Â  Â  Â  Â  Â  Â  const row = data[i];

Â  Â  Â  Â  Â  Â  Â  Â  if (!row || row.length < 5 || !row[0]) continue;

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  const priceType = row[2].trim().toUpperCase();

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  // >>>>> CAMBIO CLAVE AQUÃ <<<<<

Â  Â  Â  Â  Â  Â  Â  Â  // Si el tipo de precio es VIP o WEBALIA, no procesamos esta fila de precio.

Â  Â  Â  Â  Â  Â  Â  Â  if (priceType.includes('VIP') || priceType.includes('PRECIOS WEBALIA')) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;Â 

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  const sku = row[0].trim();

Â  Â  Â  Â  Â  Â  Â  Â  if (!localPrices[sku]) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const desc = row[1].trim();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cat = getCategoriaPrecios(desc);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  products.push({ sku, description: desc, family: sku.substring(0, 2), priceCategory: cat });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localPrices[sku] = [];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  categories.add(cat);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  const priceNet = parseFloat(row[3]);

Â  Â  Â  Â  Â  Â  Â  Â  if (priceNet > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localPrices[sku].push({ type: row[2].trim(), net: priceNet, gross: parseFloat(row[4]) || 0 });

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  allProducts = products.sort((a,b) => a.description.localeCompare(b.description));

Â  Â  Â  Â  Â  Â  pricesBySku = localPrices;

Â  Â  Â  Â  Â  Â  const catFilter = document.getElementById('categoryFilter');

Â  Â  Â  Â  Â  Â  Array.from(categories).sort().forEach(c => catFilter.innerHTML += `<option value="${c}">${c}</option>`);

Â  Â  Â  Â  Â  Â  clearProductDisplay();

Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  Â  Â  document.getElementById('loading-section').style.display = 'none';

Â  Â  Â  Â  Â  Â  document.getElementById('main-app').style.display = 'block';

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function clearProductDisplay() {

Â  Â  Â  Â  Â  Â  document.getElementById('productsContainer').innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Ingrese un tÃ©rmino de bÃºsqueda para comenzar.</div>';

Â  Â  Â  Â  }



Â  Â  Â  Â  function filterProducts() {

Â  Â  Â  Â  Â  Â  const searchTerm = document.getElementById('searchInput').value.toLowerCase();

Â  Â  Â  Â  Â  Â  const categoryFilter = document.getElementById('categoryFilter').value;

Â  Â  Â  Â  Â  Â  if (!searchTerm && !categoryFilter) {

Â  Â  Â  Â  Â  Â  Â  Â  clearProductDisplay();

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const itemsPerPage = document.getElementById('itemsPerPage').value;

Â  Â  Â  Â  Â  Â  let filtered = allProducts.filter(p =>Â 

Â  Â  Â  Â  Â  Â  Â  Â  (searchTerm && (p.sku.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm))) ||

Â  Â  Â  Â  Â  Â  Â  Â  (categoryFilter && p.priceCategory === categoryFilter)

Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (itemsPerPage !== 'all') filtered = filtered.slice(0, parseInt(itemsPerPage));

Â  Â  Â  Â  Â  Â  displayProducts(filtered);

Â  Â  Â  Â  }



Â  Â  Â  Â  function displayProducts(products) {

Â  Â  Â  Â  Â  Â  const container = document.getElementById('productsContainer');

Â  Â  Â  Â  Â  Â  container.innerHTML = products.length === 0Â 

Â  Â  Â  Â  Â  Â  Â  Â  ? '<div style="text-align:center;padding:20px;">No se encontraron productos para su bÃºsqueda.</div>'

Â  Â  Â  Â  Â  Â  Â  Â  : `<div class="products-grid">${products.map(p => `

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-card">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-sku">${p.sku}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-description">${p.description}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="quantity-input">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" min="1" value="1" id="qty-${p.sku}">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="addToOrder('${p.sku}')">Agregar</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`).join('')}</div>`;

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function addToOrder(sku) {

Â  Â  Â  Â  Â  Â  const product = allProducts.find(p => p.sku === sku);

Â  Â  Â  Â  Â  Â  const quantity = parseInt(document.getElementById(`qty-${sku}`).value) || 1;

Â  Â  Â  Â  Â  Â  const existingItem = currentOrder.find(item => item.sku === sku);

Â  Â  Â  Â  Â  Â  if (existingItem) {

Â  Â  Â  Â  Â  Â  Â  Â  existingItem.quantity += quantity;

Â  Â  Â  Â  Â  Â  Â  Â  existingItem.manualLock = false;Â 

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  currentOrder.push({ ...product, quantity, manualLock: false });

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById(`qty-${sku}`).value = 1;

Â  Â  Â  Â  Â  Â  updateAllPricesInOrder();

Â  Â  Â  Â  }



Â  Â  Â  Â  function removeFromOrder(index) {

Â  Â  Â  Â  Â  Â  currentOrder.splice(index, 1);

Â  Â  Â  Â  Â  Â  updateAllPricesInOrder();

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function updateQuantityInOrder(index, newQuantityStr) {

Â  Â  Â  Â  Â  Â  const newQuantity = parseInt(newQuantityStr);

Â  Â  Â  Â  Â  Â  if (!isNaN(newQuantity) && newQuantity > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  currentOrder[index].quantity = newQuantity;

Â  Â  Â  Â  Â  Â  Â  Â  currentOrder[index].manualLock = false;

Â  Â  Â  Â  Â  Â  Â  Â  updateAllPricesInOrder();

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function manuallyUpdatePrice(index, newPriceStr) {

Â  Â  Â  Â  Â  Â  const newPrice = parseFloat(newPriceStr);

Â  Â  Â  Â  Â  Â  const item = currentOrder[index];

Â  Â  Â  Â  Â  Â  const showPrices = document.getElementById('showPrices').value;



Â  Â  Â  Â  Â  Â  if (isNaN(newPrice) || newPrice < 0) {

Â  Â  Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  item.manualLock = true;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  if (showPrices === 'BRUTO') {

Â  Â  Â  Â  Â  Â  Â  Â  item.priceData.gross = newPrice;

Â  Â  Â  Â  Â  Â  Â  Â  item.priceData.net = newPrice / 1.19;

Â  Â  Â  Â  Â  Â  } else { // NETO

Â  Â  Â  Â  Â  Â  Â  Â  item.priceData.net = newPrice;

Â  Â  Â  Â  Â  Â  Â  Â  item.priceData.gross = newPrice * 1.19;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  item.priceData.type = 'MANUAL';

Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  }



Â  Â  Â  Â  function updateAllPricesInOrder() {

Â  Â  Â  Â  Â  Â  const categoryQuantities = currentOrder.reduce((acc, item) => {

Â  Â  Â  Â  Â  Â  Â  Â  acc[item.priceCategory] = (acc[item.priceCategory] || 0) + item.quantity;

Â  Â  Â  Â  Â  Â  Â  Â  return acc;

Â  Â  Â  Â  Â  Â  }, {});

Â  Â  Â  Â  Â  Â  currentOrder.forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  if (!item.manualLock) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.priceData = getBestPrice(item.sku, categoryQuantities[item.priceCategory]);

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function getTier(priceTypeStr) {

Â  Â  Â  Â  Â  Â  const type = (priceTypeStr || '').toUpperCase();

Â  Â  Â  Â  Â  Â  let minQty = 0;

Â  Â  Â  Â  Â  Â  const match = type.match(/(\d+)/);

Â  Â  Â  Â  Â  Â  if (type.includes('DETALLE')) minQty = 1;

Â  Â  Â  Â  Â  Â  else if (type.includes('MAYOR') && !match) minQty = 2;

Â  Â  Â  Â  Â  Â  else if (match) minQty = parseInt(match[1], 10);

Â  Â  Â  Â  Â  Â  return { type: priceTypeStr, minQty };

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function getBestPrice(sku, totalCategoryQuantity) {

Â  Â  Â  Â  Â  Â  const availablePrices = pricesBySku[sku] || [];

Â  Â  Â  Â  Â  Â  if (availablePrices.length === 0) return { type: "SIN PRECIO", net: 0, gross: 0 };

Â  Â  Â  Â  Â  Â  const tiers = availablePrices.map(p => ({ ...p, minQty: getTier(p.type).minQty }));

Â  Â  Â  Â  Â  Â  const applicableTiers = tiers.filter(t => totalCategoryQuantity >= t.minQty);

Â  Â  Â  Â  Â  Â  if (applicableTiers.length > 0) return applicableTiers.reduce((best, current) => current.minQty > best.minQty ? current : best);

Â  Â  Â  Â  Â  Â  return tiers.find(t => t.type.includes(document.getElementById('globalPriceSelector').value.toUpperCase())) || tiers[0];

Â  Â  Â  Â  }



Â  Â  Â  Â  function manuallySetPrice(index, newType) {

Â  Â  Â  Â  Â  Â  const item = currentOrder[index];

Â  Â  Â  Â  Â  Â  if (newType === 'MANUAL') return;Â 

Â  Â  Â  Â  Â  Â  const newPrice = pricesBySku[item.sku].find(p => p.type === newType);

Â  Â  Â  Â  Â  Â  if (newPrice) {

Â  Â  Â  Â  Â  Â  Â  Â  item.priceData = newPrice;

Â  Â  Â  Â  Â  Â  Â  Â  item.manualLock = true;

Â  Â  Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function resetPrice(index) {

Â  Â  Â  Â  Â  Â  currentOrder[index].manualLock = false;

Â  Â  Â  Â  Â  Â  currentOrder[index].priceData.type = '';Â 

Â  Â  Â  Â  Â  Â  updateAllPricesInOrder();

Â  Â  Â  Â  }



Â  Â  Â  Â  function applyGlobalPrice() {

Â  Â  Â  Â  Â  Â  const globalType = document.getElementById('globalPriceSelector').value.toUpperCase();

Â  Â  Â  Â  Â  Â  let updatedCount = 0;

Â  Â  Â  Â  Â  Â  currentOrder.forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  let targetPrice;

Â  Â  Â  Â  Â  Â  Â  Â  const availablePrices = pricesBySku[item.sku] || [];

Â  Â  Â  Â  Â  Â  Â  Â  if (globalType === 'MAYOR') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tiers = availablePrices.map(p => ({ ...p, minQty: getTier(p.type).minQty }));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mayorTiers = tiers.filter(t => t.minQty > 1);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (mayorTiers.length > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetPrice = mayorTiers.reduce((best, current) => current.minQty < best.minQty ? current : best);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetPrice = availablePrices.find(p => p.type.toUpperCase().includes(globalType));

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (targetPrice) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.priceData = targetPrice;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.manualLock = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedCount++;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (updatedCount > 0) updateOrderDisplay();

Â  Â  Â  Â  Â  Â  else alert(`No se encontraron precios del tipo "${globalType}" para aplicar.`);

Â  Â  Â  Â  }



Â  Â  Â  Â  function updateOrderDisplay() {

Â  Â  Â  Â  Â  Â  const container = document.getElementById('orderItems');

Â  Â  Â  Â  Â  Â  const totalEl = document.getElementById('orderTotal');

Â  Â  Â  Â  Â  Â  const showPrices = document.getElementById('showPrices').value;



Â  Â  Â  Â  Â  Â  if (currentOrder.length === 0) {

Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No hay productos en el pedido.</div>';

Â  Â  Â  Â  Â  Â  Â  Â  totalEl.textContent = '$0'; return;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  let grandTotal = 0;

Â  Â  Â  Â  Â  Â  container.innerHTML = currentOrder.sort((a,b) => a.description.localeCompare(b.description)).map((item, index) => {

Â  Â  Â  Â  Â  Â  Â  Â  const originalIndex = currentOrder.indexOf(item);

Â  Â  Â  Â  Â  Â  Â  Â  const price = item.priceData;

Â  Â  Â  Â  Â  Â  Â  Â  const unitPrice = showPrices === 'BRUTO' ? price.gross : price.net;

Â  Â  Â  Â  Â  Â  Â  Â  const lineTotal = unitPrice * item.quantity;

Â  Â  Â  Â  Â  Â  Â  Â  grandTotal += lineTotal;

Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  let priceOptions = (pricesBySku[item.sku] || []).map(p => `<option value="${p.type}" ${p.type === price.type ? 'selected' : ''}>${p.type}</option>`).join('');

Â  Â  Â  Â  Â  Â  Â  Â  if (item.manualLock && item.priceData.type === 'MANUAL') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  priceOptions = `<option value="MANUAL" selected>MANUAL</option>${priceOptions}`;

Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="order-item">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-remove-item" onclick="removeFromOrder(${originalIndex})">Ã—</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-item-info">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="sku">${item.sku}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="desc">${item.description}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="order-item-controls">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" value="${item.quantity}" min="1" onchange="updateQuantityInOrder(${originalIndex}, this.value)">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="price-details">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="unit-price-input" value="${Math.round(unitPrice)}" onchange="manuallyUpdatePrice(${originalIndex}, this.value)">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b class="line-total">${lineTotal.toLocaleString('es-CL')}</b>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="price-override-section">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="manuallySetPrice(${originalIndex}, this.value)">${priceOptions}</select>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.manualLock ? `<button class="btn-reset" onclick="resetPrice(${originalIndex})">Reset</button>` : ''}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  totalEl.textContent = `${grandTotal.toLocaleString('es-CL')}`;

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function clearOrder() {

Â  Â  Â  Â  Â  Â  if (confirm('Â¿Deseas limpiar el pedido?')) {

Â  Â  Â  Â  Â  Â  Â  Â  currentOrder = [];

Â  Â  Â  Â  Â  Â  Â  Â  updateOrderDisplay();

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function generateExcelOutput() {

Â  Â  Â  Â  Â  Â  if (currentOrder.length === 0) { alert('No hay productos'); return; }

Â  Â  Â  Â  Â  Â  const showPrices = document.getElementById('showPrices').value;

Â  Â  Â  Â  Â  Â  let output = 'Cantidad\tCÃ³digo de Barras, SKU o NÃºmero de Serie\tGlosa\tValor Unitario\n';

Â  Â  Â  Â  Â  Â  currentOrder.sort((a,b) => a.description.localeCompare(b.description)).forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  const unitPrice = showPrices === 'BRUTO' ? item.priceData.gross : item.priceData.net;

Â  Â  Â  Â  Â  Â  Â  Â  output += `${item.quantity}\t${item.sku}\t${item.description}\t${Math.round(unitPrice)}\n`;

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  copyToClipboard(output, 'Â¡Texto para Sistema copiado!');

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function generateWhatsappSummary() {

Â  Â  Â  Â  Â  Â  if (currentOrder.length === 0) { alert('No hay productos'); return; }

Â  Â  Â  Â  Â  Â  const showPrices = document.getElementById('showPrices').value;

Â  Â  Â  Â  Â  Â  const currencyFormat = { style: 'currency', currency: 'CLP' };

Â  Â  Â  Â  Â  Â  const grandTotal = currentOrder.reduce((sum, item) => sum + (showPrices === 'BRUTO' ? item.priceData.gross : item.priceData.net) * item.quantity, 0);

Â  Â  Â  Â  Â  Â  const groupedByCategory = currentOrder.reduce((acc, item) => {

Â  Â  Â  Â  Â  Â  Â  Â  if (!acc[item.priceCategory]) acc[item.priceCategory] = { items: [], totalQty: 0 };

Â  Â  Â  Â  Â  Â  Â  Â  acc[item.priceCategory].items.push(item);

Â  Â  Â  Â  Â  Â  Â  Â  acc[item.priceCategory].totalQty += item.quantity;

Â  Â  Â  Â  Â  Â  Â  Â  return acc;

Â  Â  Â  Â  Â  Â  }, {});



Â  Â  Â  Â  Â  Â  let note = '*Resumen de Pedido* ğŸ›ï¸\n\n';

Â  Â  Â  Â  Â  Â  Object.keys(groupedByCategory).sort().forEach(category => {

Â  Â  Â  Â  Â  Â  Â  Â  const group = groupedByCategory[category];

Â  Â  Â  Â  Â  Â  Â  Â  note += `*${category}* (Total: ${group.totalQty} unidades)\n`;

Â  Â  Â  Â  Â  Â  Â  Â  group.items.sort((a,b) => a.description.localeCompare(b.description)).forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const unitPrice = showPrices === 'BRUTO' ? item.priceData.gross : item.priceData.net;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lineTotal = unitPrice * item.quantity;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  note += `- ${item.quantity} x ${item.description} (${unitPrice.toLocaleString('es-CL', currencyFormat)}) = ${lineTotal.toLocaleString('es-CL', currencyFormat)}\n`;

Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  note += '\n';

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  note += `--------------------\n*Total Estimado: ${grandTotal.toLocaleString('es-CL', currencyFormat)}*`;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  copyToClipboard(note, 'Â¡Resumen para WhatsApp copiado!');

Â  Â  Â  Â  }



Â  Â  Â  Â  function generateSummaryNote() {

Â  Â  Â  Â  Â  Â  if (currentOrder.length === 0) { alert('No hay productos'); return; }

Â  Â  Â  Â  Â  Â  const delivery = document.getElementById('deliveryMode').value;

Â  Â  Â  Â  Â  Â  const docType = document.getElementById('documentType').value;

Â  Â  Â  Â  Â  Â  const unitsByCategory = currentOrder.reduce((acc, item) => {

Â  Â  Â  Â  Â  Â  Â  Â  acc[item.priceCategory] = (acc[item.priceCategory] || 0) + item.quantity;

Â  Â  Â  Â  Â  Â  Â  Â  return acc;

Â  Â  Â  Â  Â  Â  }, {});

Â  Â  Â  Â  Â  Â  const totalItems = currentOrder.reduce((sum, item) => sum + item.quantity, 0);

Â  Â  Â  Â  Â  Â  const categorySummary = Object.keys(unitsByCategory).sort().map(cat => `${unitsByCategory[cat]} ${cat}`).join(', ');

Â  Â  Â  Â  Â  Â  const finalLine = `BODEGA ${delivery}: ${categorySummary}// ADM ${docType} _Total Ã­tems: ${totalItems}`;

Â  Â  Â  Â  Â  Â  copyToClipboard(finalLine, 'Â¡Nota para Bodega copiada!');

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function downloadExcel() {

Â  Â  Â  Â  Â  Â  if (currentOrder.length === 0) { alert('No hay productos en el pedido.'); return; }

Â  Â  Â  Â  Â  Â  const clientName = document.getElementById('clientName').value.trim();

Â  Â  Â  Â  Â  Â  if (!clientName) { alert('Por favor, ingrese un nombre de cliente.'); return; }

Â  Â  Â  Â  Â  Â  const fileName = `${clientName.replace(/ /g, "_")}.csv`;

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const toCsvRow = (arr) => arr.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  let csvContent = "\uFEFF";



Â  Â  Â  Â  Â  Â  const metaHeaders = ['META_CLIENTE', 'META_MODALIDAD', 'META_DOCUMENTO', 'META_VISTA_PRECIOS'];

Â  Â  Â  Â  Â  Â  const metaValues = [

Â  Â  Â  Â  Â  Â  Â  Â  clientName,

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('deliveryMode').value,

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('documentType').value,

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('showPrices').value

Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  csvContent += toCsvRow(metaHeaders) + '\r\n';

Â  Â  Â  Â  Â  Â  csvContent += toCsvRow(metaValues) + '\r\n\r\n';



Â  Â  Â  Â  Â  Â  const productHeaders = ['Cantidad', 'CÃ³digo de Barras, SKU o NÃºmero de Serie', 'Glosa', 'Valor Unitario'];

Â  Â  Â  Â  Â  Â  csvContent += toCsvRow(productHeaders) + '\r\n';



Â  Â  Â  Â  Â  Â  currentOrder.sort((a,b) => a.description.localeCompare(b.description)).forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  const showPrices = document.getElementById('showPrices').value;

Â  Â  Â  Â  Â  Â  Â  Â  const unitPrice = showPrices === 'BRUTO' ? item.priceData.gross : item.priceData.net;

Â  Â  Â  Â  Â  Â  Â  Â  const row = [item.quantity, item.sku, item.description, Math.round(unitPrice)];

Â  Â  Â  Â  Â  Â  Â  Â  csvContent += toCsvRow(row) + '\r\n';

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

Â  Â  Â  Â  Â  Â  const link = document.createElement("a");

Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);

Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);

Â  Â  Â  Â  Â  Â  link.setAttribute("download", fileName);

Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';

Â  Â  Â  Â  Â  Â  document.body.appendChild(link);

Â  Â  Â  Â  Â  Â  link.click();

Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  }



Â  Â  Â  Â  function downloadBsaleCsv() {

Â  Â  Â  Â  Â  Â  if (currentOrder.length === 0) { alert('No hay productos en el pedido.'); return; }

Â  Â  Â  Â  Â  Â  const clientName = document.getElementById('clientName').value.trim();

Â  Â  Â  Â  Â  Â  const fileName = `BSale_${clientName.replace(/ /g, "_") || 'pedido'}.csv`;



Â  Â  Â  Â  Â  Â  const headers = ['SKU', 'Cantidad', 'Neto Unitario', 'Descuento %'];

Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  let content = "\uFEFF";

Â  Â  Â  Â  Â  Â  content += headers.join('\t') + '\r\n';



Â  Â  Â  Â  Â  Â  currentOrder.forEach(item => {

Â  Â  Â  Â  Â  Â  Â  Â  const priceToExport = item.priceData.gross;

Â  Â  Â  Â  Â  Â  Â  Â  const row = [

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.sku,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.quantity,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Math.round(priceToExport),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0Â 

Â  Â  Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  Â  Â  content += row.join('\t') + '\r\n';

Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  const blob = new Blob([content], { type: 'text/tab-separated-values;charset=utf-8;' });

Â  Â  Â  Â  Â  Â  const link = document.createElement("a");

Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);

Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);

Â  Â  Â  Â  Â  Â  link.setAttribute("download", fileName);

Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';

Â  Â  Â  Â  Â  Â  document.body.appendChild(link);

Â  Â  Â  Â  Â  Â  link.click();

Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  }



Â  Â  Â  Â  function triggerImport() {

Â  Â  Â  Â  Â  Â  document.getElementById('importFile').click();

Â  Â  Â  Â  }



Â  Â  Â  Â  function importOrder(event) {

Â  Â  Â  Â  Â  Â  const file = event.target.files[0];

Â  Â  Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  Â  Â  if (currentOrder.length > 0 && !confirm('Â¿Importar este pedido? Se reemplazarÃ¡ el pedido actual.')) {

Â  Â  Â  Â  Â  Â  Â  Â  event.target.value = ''; return;

Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Papa.parse(file, {

Â  Â  Â  Â  Â  Â  Â  Â  header: false,

Â  Â  Â  Â  Â  Â  Â  Â  skipEmptyLines: true,

Â  Â  Â  Â  Â  Â  Â  Â  complete: (results) => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = results.data;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.length > 1 && data[0][0] === 'META_CLIENTE') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const metaValues = data[1];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clientName').value = metaValues[0];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('deliveryMode').value = metaValues[1];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('documentType').value = metaValues[2];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('showPrices').value = metaValues[3];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const headerRowIndex = data.findIndex(row => row[0] === 'Cantidad');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(headerRowIndex === -1) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alert('No se encontrÃ³ la cabecera de productos en el archivo. No se puede importar.');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const productData = data.slice(headerRowIndex + 1);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newOrder = [];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const notFound = [];



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  productData.forEach(row => {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const quantity = parseInt(row[0]);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sku = row[1];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sku && quantity > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const product = allProducts.find(p => p.sku === sku.trim());

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (product) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newOrder.push({ ...product, quantity, manualLock: false });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notFound.push(sku);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });



Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentOrder = newOrder;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateAllPricesInOrder();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (notFound.length > 0) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Se importÃ³ el pedido, pero los siguientes SKUs no se encontraron en el catÃ¡logo actual y fueron omitidos:\n${notFound.join(', ')}`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.target.value = '';

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  }



Â  Â  Â  Â  function copyToClipboard(text, message) {

Â  Â  Â  Â  Â  Â  const out = document.getElementById('copyOutput');

Â  Â  Â  Â  Â  Â  out.textContent = text;

Â  Â  Â  Â  Â  Â  out.style.display = 'block';

Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(text).then(() => alert(message), () => alert('Error al copiar.'));

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {

Â  Â  Â  Â  Â  Â  loadCatalogFromUrl();

Â  Â  Â  Â  Â  Â  document.getElementById('importFile').addEventListener('change', importOrder);

Â  Â  Â  Â  Â  Â  document.getElementById('showPrices').addEventListener('change', updateAllPricesInOrder);

Â  Â  Â  Â  });

Â  Â  </script>

</body>

</html>
